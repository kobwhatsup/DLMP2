# AlertManageré…ç½®æ–‡ä»¶
# DLMPç³»ç»Ÿå‘Šè­¦ç®¡ç†é…ç½®

global:
  # SMTPé…ç½®
  smtp_smarthost: 'smtp.example.com:587'
  smtp_from: 'alertmanager@dlmp.example.com'
  smtp_auth_username: 'alertmanager@dlmp.example.com'
  smtp_auth_password: 'your-email-password'
  smtp_require_tls: true

  # è§£æè¶…æ—¶
  resolve_timeout: 5m

# æ¨¡æ¿é…ç½®
templates:
  - '/etc/alertmanager/templates/*.tmpl'

# è·¯ç”±é…ç½®
route:
  # é»˜è®¤åˆ†ç»„é”®
  group_by: ['alertname', 'cluster', 'service']
  
  # åˆ†ç»„ç­‰å¾…æ—¶é—´
  group_wait: 10s
  
  # åˆ†ç»„é—´éš”æ—¶é—´
  group_interval: 10s
  
  # é‡å¤å‘é€é—´éš”
  repeat_interval: 1h
  
  # é»˜è®¤æ¥æ”¶å™¨
  receiver: 'default'
  
  # å­è·¯ç”±
  routes:
    # ä¸¥é‡å‘Šè­¦ç«‹å³é€šçŸ¥
    - match:
        severity: critical
      receiver: 'critical-alerts'
      group_wait: 0s
      group_interval: 5s
      repeat_interval: 15m
      continue: true
    
    # ç³»ç»Ÿç›¸å…³å‘Šè­¦
    - match:
        category: system
      receiver: 'system-alerts'
      group_by: ['alertname', 'instance']
      repeat_interval: 4h
    
    # åº”ç”¨ç›¸å…³å‘Šè­¦
    - match:
        category: application
      receiver: 'application-alerts'
      group_by: ['alertname', 'service', 'instance']
      repeat_interval: 2h
    
    # æ•°æ®åº“ç›¸å…³å‘Šè­¦
    - match:
        category: database
      receiver: 'database-alerts'
      group_by: ['alertname', 'instance']
      repeat_interval: 1h
    
    # ç½‘ç»œç›¸å…³å‘Šè­¦
    - match:
        category: network
      receiver: 'network-alerts'
      group_by: ['alertname', 'instance']
      repeat_interval: 30m
    
    # ä¸šåŠ¡ç›¸å…³å‘Šè­¦
    - match:
        category: business
      receiver: 'business-alerts'
      group_by: ['alertname']
      repeat_interval: 30m
    
    # å®¹å™¨ç›¸å…³å‘Šè­¦
    - match:
        category: container
      receiver: 'devops-alerts'
      group_by: ['alertname', 'container']
      repeat_interval: 2h
    
    # æµ‹è¯•ç¯å¢ƒå‘Šè­¦ï¼ˆé™çº§å¤„ç†ï¼‰
    - match:
        cluster: dlmp-testing
      receiver: 'testing-alerts'
      group_interval: 5m
      repeat_interval: 24h

# æŠ‘åˆ¶è§„åˆ™
inhibit_rules:
  # èŠ‚ç‚¹ç¦»çº¿æ—¶æŠ‘åˆ¶è¯¥èŠ‚ç‚¹çš„å…¶ä»–å‘Šè­¦
  - source_match:
      alertname: NodeDown
    target_match_re:
      instance: '.*'
    equal: ['instance']
  
  # æœåŠ¡ç¦»çº¿æ—¶æŠ‘åˆ¶è¯¥æœåŠ¡çš„å…¶ä»–å‘Šè­¦
  - source_match:
      alertname: ServiceDown
    target_match_re:
      alertname: 'High.*|.*Error.*'
    equal: ['service', 'instance']
  
  # ä¸¥é‡å‘Šè­¦æŠ‘åˆ¶è­¦å‘Šçº§åˆ«å‘Šè­¦
  - source_match:
      severity: critical
    target_match:
      severity: warning
    equal: ['alertname', 'instance']

# æ¥æ”¶å™¨é…ç½®
receivers:
  # é»˜è®¤æ¥æ”¶å™¨
  - name: 'default'
    email_configs:
      - to: 'admin@dlmp.example.com'
        subject: 'DLMPå‘Šè­¦é€šçŸ¥'
        body: |
          {{ range .Alerts }}
          å‘Šè­¦åç§°: {{ .Annotations.summary }}
          å‘Šè­¦æè¿°: {{ .Annotations.description }}
          å‘Šè­¦çº§åˆ«: {{ .Labels.severity }}
          å®ä¾‹: {{ .Labels.instance }}
          æ—¶é—´: {{ .StartsAt.Format "2006-01-02 15:04:05" }}
          {{ end }}

  # ä¸¥é‡å‘Šè­¦æ¥æ”¶å™¨
  - name: 'critical-alerts'
    email_configs:
      - to: 'admin@dlmp.example.com,manager@dlmp.example.com'
        subject: 'ğŸš¨ DLMPä¸¥é‡å‘Šè­¦ ğŸš¨'
        body: |
          âš ï¸ æ£€æµ‹åˆ°ä¸¥é‡å‘Šè­¦ï¼Œè¯·ç«‹å³å¤„ç†ï¼
          
          {{ range .Alerts }}
          ğŸ“ å‘Šè­¦åç§°: {{ .Annotations.summary }}
          ğŸ“ å‘Šè­¦æè¿°: {{ .Annotations.description }}
          ğŸ”¥ å‘Šè­¦çº§åˆ«: {{ .Labels.severity }}
          ğŸ–¥ï¸  å®ä¾‹: {{ .Labels.instance }}
          â° å¼€å§‹æ—¶é—´: {{ .StartsAt.Format "2006-01-02 15:04:05" }}
          ğŸ“Š å½“å‰å€¼: {{ .Annotations.value }}
          {{ end }}
        headers:
          Priority: 'high'
    
    webhook_configs:
      - url: 'http://webhook-server:8080/alerts/critical'
        send_resolved: true
        http_config:
          basic_auth:
            username: 'webhook_user'
            password: 'webhook_password'
    
    # é’‰é’‰æœºå™¨äººé€šçŸ¥
    webhook_configs:
      - url: 'https://oapi.dingtalk.com/robot/send?access_token=YOUR_DINGTALK_TOKEN'
        send_resolved: true
        http_config:
          proxy_url: 'http://proxy:8080'
        title: 'DLMPä¸¥é‡å‘Šè­¦'
        text: |
          ## ğŸš¨ DLMPä¸¥é‡å‘Šè­¦
          {{ range .Alerts }}
          **å‘Šè­¦åç§°**: {{ .Annotations.summary }}
          
          **å‘Šè­¦æè¿°**: {{ .Annotations.description }}
          
          **å‘Šè­¦çº§åˆ«**: {{ .Labels.severity }}
          
          **å®ä¾‹**: {{ .Labels.instance }}
          
          **æ—¶é—´**: {{ .StartsAt.Format "2006-01-02 15:04:05" }}
          {{ end }}

  # ç³»ç»Ÿå‘Šè­¦æ¥æ”¶å™¨
  - name: 'system-alerts'
    email_configs:
      - to: 'sysadmin@dlmp.example.com'
        subject: 'DLMPç³»ç»Ÿå‘Šè­¦'
        body: |
          ç³»ç»Ÿç›‘æ§å‘ç°å¼‚å¸¸ï¼Œè¯·å…³æ³¨ï¼š
          
          {{ range .Alerts }}
          å‘Šè­¦: {{ .Annotations.summary }}
          è¯¦æƒ…: {{ .Annotations.description }}
          èŠ‚ç‚¹: {{ .Labels.instance }}
          æ—¶é—´: {{ .StartsAt.Format "2006-01-02 15:04:05" }}
          {{ end }}

  # åº”ç”¨å‘Šè­¦æ¥æ”¶å™¨
  - name: 'application-alerts'
    email_configs:
      - to: 'devteam@dlmp.example.com'
        subject: 'DLMPåº”ç”¨å‘Šè­¦'
        body: |
          åº”ç”¨ç›‘æ§å‘ç°å¼‚å¸¸ï¼Œè¯·åŠæ—¶å¤„ç†ï¼š
          
          {{ range .Alerts }}
          åº”ç”¨: {{ .Labels.service }}
          å‘Šè­¦: {{ .Annotations.summary }}
          è¯¦æƒ…: {{ .Annotations.description }}
          å®ä¾‹: {{ .Labels.instance }}
          æ—¶é—´: {{ .StartsAt.Format "2006-01-02 15:04:05" }}
          {{ end }}

  # æ•°æ®åº“å‘Šè­¦æ¥æ”¶å™¨
  - name: 'database-alerts'
    email_configs:
      - to: 'dba@dlmp.example.com,devteam@dlmp.example.com'
        subject: 'DLMPæ•°æ®åº“å‘Šè­¦'
        body: |
          æ•°æ®åº“ç›‘æ§å‘ç°å¼‚å¸¸ï¼Œè¯·ç«‹å³å¤„ç†ï¼š
          
          {{ range .Alerts }}
          æ•°æ®åº“: {{ .Labels.job }}
          å‘Šè­¦: {{ .Annotations.summary }}
          è¯¦æƒ…: {{ .Annotations.description }}
          å®ä¾‹: {{ .Labels.instance }}
          æ—¶é—´: {{ .StartsAt.Format "2006-01-02 15:04:05" }}
          {{ end }}

  # ç½‘ç»œå‘Šè­¦æ¥æ”¶å™¨
  - name: 'network-alerts'
    email_configs:
      - to: 'netadmin@dlmp.example.com'
        subject: 'DLMPç½‘ç»œå‘Šè­¦'
        body: |
          ç½‘ç»œç›‘æ§å‘ç°å¼‚å¸¸ï¼š
          
          {{ range .Alerts }}
          ç›®æ ‡: {{ .Labels.instance }}
          å‘Šè­¦: {{ .Annotations.summary }}
          è¯¦æƒ…: {{ .Annotations.description }}
          æ—¶é—´: {{ .StartsAt.Format "2006-01-02 15:04:05" }}
          {{ end }}

  # ä¸šåŠ¡å‘Šè­¦æ¥æ”¶å™¨
  - name: 'business-alerts'
    email_configs:
      - to: 'business@dlmp.example.com,manager@dlmp.example.com'
        subject: 'DLMPä¸šåŠ¡å‘Šè­¦'
        body: |
          ä¸šåŠ¡ç›‘æ§å‘ç°å¼‚å¸¸ï¼Œå¯èƒ½å½±å“ç”¨æˆ·ä½“éªŒï¼š
          
          {{ range .Alerts }}
          ä¸šåŠ¡æŒ‡æ ‡: {{ .Labels.alertname }}
          å‘Šè­¦: {{ .Annotations.summary }}
          è¯¦æƒ…: {{ .Annotations.description }}
          å½“å‰å€¼: {{ .Annotations.value }}
          æ—¶é—´: {{ .StartsAt.Format "2006-01-02 15:04:05" }}
          {{ end }}

  # DevOpså‘Šè­¦æ¥æ”¶å™¨
  - name: 'devops-alerts'
    email_configs:
      - to: 'devops@dlmp.example.com'
        subject: 'DLMPå®¹å™¨/ç¼–æ’å‘Šè­¦'
        body: |
          å®¹å™¨æˆ–ç¼–æ’ç³»ç»Ÿå‘ç°å¼‚å¸¸ï¼š
          
          {{ range .Alerts }}
          å®¹å™¨: {{ .Labels.container }}
          å‘Šè­¦: {{ .Annotations.summary }}
          è¯¦æƒ…: {{ .Annotations.description }}
          æ—¶é—´: {{ .StartsAt.Format "2006-01-02 15:04:05" }}
          {{ end }}

  # æµ‹è¯•ç¯å¢ƒå‘Šè­¦æ¥æ”¶å™¨
  - name: 'testing-alerts'
    email_configs:
      - to: 'qa@dlmp.example.com'
        subject: 'DLMPæµ‹è¯•ç¯å¢ƒå‘Šè­¦'
        body: |
          æµ‹è¯•ç¯å¢ƒç›‘æ§å‘Šè­¦ï¼ˆéç´§æ€¥ï¼‰ï¼š
          
          {{ range .Alerts }}
          å‘Šè­¦: {{ .Annotations.summary }}
          è¯¦æƒ…: {{ .Annotations.description }}
          æ—¶é—´: {{ .StartsAt.Format "2006-01-02 15:04:05" }}
          {{ end }}

# æ—¶é—´çª—å£é…ç½®
time_intervals:
  # å·¥ä½œæ—¶é—´
  - name: 'business-hours'
    time_intervals:
      - times:
          - start_time: '09:00'
            end_time: '18:00'
        weekdays: ['monday:friday']
        location: 'Asia/Shanghai'
  
  # éå·¥ä½œæ—¶é—´
  - name: 'after-hours'
    time_intervals:
      - times:
          - start_time: '18:00'
            end_time: '09:00'
        weekdays: ['monday:friday']
        location: 'Asia/Shanghai'
      - weekdays: ['saturday', 'sunday']
        location: 'Asia/Shanghai'